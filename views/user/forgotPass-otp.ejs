<!DOCTYPE html>
<html lang="zxx">

<head>
    <meta charset="UTF-8">
    <meta name="description" content="Male_Fashion Template">
    <meta name="keywords" content="Male_Fashion, unica, creative, html">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="icon" href="/img/favicon.png" type="image/png">
    <title>STYLE AND VIBE</title>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@300;400;600;700;800;900&display=swap"
    rel="stylesheet">

    <!-- Css Styles -->
    <link rel="stylesheet" href="css/bootstrap.min.css" type="text/css">
    <link rel="stylesheet" href="css/font-awesome.min.css" type="text/css">
    <link rel="stylesheet" href="css/elegant-icons.css" type="text/css">
    <link rel="stylesheet" href="css/magnific-popup.css" type="text/css">
    <link rel="stylesheet" href="css/nice-select.css" type="text/css">
    <link rel="stylesheet" href="css/owl.carousel.min.css" type="text/css">
    <link rel="stylesheet" href="css/slicknav.min.css" type="text/css">
    <link rel="stylesheet" href="css/style.css" type="text/css">
</head>

<style>
 .otp-container {
   display: flex;
   flex-direction: column;
   align-items: center;
   padding: 20px;
   border: 1px solid #ddd;
   border-radius: 10px;
   background-color: #f9f9f9;
   width: 100%;
   max-width: 400px;
   margin: 0 auto;
   box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
 }


 .otp-timer-wrapper {
   display: flex;
   justify-content: center;
   align-items: center;
   margin-bottom: 10px;
   width: 100%;
 }


 .otp-timer {
   display: flex;
   justify-content: center;
   align-items: center;
   width: 60px;
   height: 60px;
   border-radius: 50%;
   background-color: #f0f0f0;
   font-size: 14px;
   color: black;
   text-align: center;
 }


 .form-group {
   width: 100%;
   text-align: center;
 }


 .btn-primary {
   margin-top: 15px;
 }


 .resend-button {
   margin-top: 10px;
 }
 .text-muted a {
    color: #007bff; /* Bootstrap blue */
    text-decoration: none;
  }

  .text-muted a:hover {
    color: #0056b3; /* Darker blue on hover */
    text-decoration: underline;
  }
  .resend-button.disabled {
  pointer-events: none;
  color: #aaa;
  cursor: not-allowed;
}

</style>

<%- include("../../views/partial/user/header") %>   

<div class="container col-4 login_wrap widget-taber-content p-30 background-white border-radius-5 mt-30">
 <div class="padding_eight_all bg-white">
   <div class="heading_s1">
     <h3 class="mb-30 text-center">Email Verification</h3>
   </div>
   <div class="otp-container">
     <form onsubmit="return validateOtpForm()" action="/verify-passForgot-otp" method="POST">
       <div class="form-group">
         <label for="otp">Enter OTP:</label>
         <input type="text" id="otp" name="otp" class="form-control" required>
       </div>
       <div class="form-group">
         <button type="submit" class="btn btn-primary">Verify OTP</button>
       </div>
     </form>
     <div class="form-group otp-timer-wrapper">
       <div class="otp-timer" id="otpTimer"></div>
     </div>
     <div class="form-group">
       <button type="button" class="btn btn-link resend-button" id="resendBtn" onclick="resendOtp()">Resend OTP</button>
     </div>
     <% if (locals.message && message.length>0) { %>
       <div class="alert alert-danger mt-3">
          <%= message %>
       </div>
      <% } %> 
   </div>
   <div class="text-muted text-center pt-25" >
     Already verified? <a href="/login">Login now</a>
   </div>
 </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


<script>
  let otpTimerInterval;
  let timer = 60;

  function updateTimerColor(percentage) {
    let timerElement = document.getElementById("otpTimer");
    if (percentage > 50) {
      timerElement.style.backgroundColor = '#28a745';
    } else if (percentage > 25) {
      timerElement.style.backgroundColor = '#ffc107';
    } else {
      timerElement.style.backgroundColor = '#dc3545';
    }
  }

  function startOtpTimer() {
    const timerElement = document.getElementById("otpTimer");
    const resendBtn = document.getElementById("resendBtn");
    resendBtn.disabled = true; 
    resendBtn.classList.add("disabled"); 

    otpTimerInterval = setInterval(function () {
      const minutes = Math.floor(timer / 60);
      const seconds = timer % 60;
      timerElement.textContent = `${minutes} : ${seconds < 10 ? '0' : ''}${seconds}`;
      updateTimerColor((timer / 60) * 100);
      
      if (--timer < 0) {
        clearInterval(otpTimerInterval);
        timerElement.textContent = "Expired";
        timerElement.style.backgroundColor = 'red';

        resendBtn.disabled = false; 
        resendBtn.classList.remove("disabled");
      }
    }, 1000);
  }

  function initializeOtpTimer() {
    clearInterval(otpTimerInterval);
    timer = 60;
    startOtpTimer();
  }

  initializeOtpTimer();

  function validateOtpForm(){
    const otpInput = document.getElementById("otp").value;
    $.ajax({
      type : 'post',
      url : '/verify-passForgot-otp',
      data : {otp : otpInput},
      success : function(response){
        if(response.success){
          Swal.fire({
            icon : 'success',
            title : 'OTP verified succesfully',
            showConfirmButton : false,
            timer : 1500
          }).then(()=>{
            window.location.href = response.redirectUrl;
          })
        }else{
          Swal.fire({
            icon :'error',
            title : 'Error',
            text : response.message
          })
        }
      },error : function(){
        Swal.fire({
          icon : 'error',
          title : 'Error',
          text : 'Failed to verify OTP, plz try again'
        })
      }
    });
    return false;
  }

  // function resendOtp(){
  //   clearInterval(otpTimerInterval);
  //   timer = 60;
  //   startOtpTimer();

  //   $.ajax({
  //     type : 'POST',
  //     url : '/resend-forgot-otp',
  //     success : function(response){
  //       if(response.success){
  //         Swal.fire({
  //           icon : 'success',
  //           title : 'Resend OTP successfull',
  //           showConfirmButton : false,
  //           timer : 1500
  //         })
  //       }else{
  //         Swal.fire({
  //           icon: 'error',
  //           title : 'Error',
  //           text : 'Failed to resend otp, try again',

  //         })
  //       }
  //     },
  //     error : function(){
  //       Swal.fire({
  //           icon: 'error',
  //           title : 'Error',
  //           text : 'Failed to resend otp, try again',
  //         })
  //     }
  //   })
  // }

  function resendOtp() {
    const timerElement = document.getElementById("otpTimer");
    if (timerElement.textContent !== "Expired") {
    Swal.fire({
      icon: "info",
      title: "Please wait",
      text: "You can resend the OTP only after the timer expires.",
      timer: 2000,
      showConfirmButton: false
    });
    return;
  }

  // Proceed to resend
  clearInterval(otpTimerInterval);
  timer = 60;
  startOtpTimer();

  $.ajax({
    type: 'POST',
    url: '/resend-forgot-otp',
    success: function (response) {
      if (response.success) {
        Swal.fire({
          icon: 'success',
          title: 'OTP resent successfully',
          showConfirmButton: false,
          timer: 1500
        });
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to resend OTP, try again.'
        });
      }
    },
    error: function () {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'Failed to resend OTP, try again.'
      });
    }
  });
}


</script>
