<%- include("../../views/partial/admin/header") %>
<head>
   <style>
       .error-message{
           color: red;
           display: none;
           font-size: 12px;
           margin-top: 5px;
       }
       .image-preview {
           max-width: 100%;
           max-height: 300px;
           border: 2px dashed #ddd;
           margin: 10px 0;
           display: block;
       }
       .image-upload-section {
           border: 1px solid #e0e0e0;
           padding: 15px;
           margin-bottom: 15px;
           border-radius: 5px;
       }
       .upload-label {
           font-weight: bold;
           color: #333;
           margin-bottom: 10px;
           display: block;
       }
   </style>
</head>

<section class="content-main">
    <div class="row">
        <div class="col-9">
            <div class="content-header">
                <h2 class="content-title">Add New Product</h2>
            </div>
        </div>
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-body">
                    <form method="post" action="/admin/addProducts" enctype="multipart/form-data" id="productForm">

                        <!-- Product Name -->
                        <div class="mb-4">
                            <label for="product_name" class="form-label">Product Name</label>
                            <input type="text" placeholder="Type here" name="productName"
                                class="form-control border" id="product_name">
                            <div id="productName-error" class="error-message"></div>
                        </div>

                        <!-- Brand -->
                        <div class="mb-4">
                            <label class="form-label">Brand</label>
                            <select class="form-select border" name="brand">
                                <%for(let i=0; i<brand.length; i++){%>
                                    <option value="<%=brand[i].brandName%>">
                                        <%= brand[i].brandName%>
                                    </option>
                                <%}%>
                            </select>
                            <div id="brand-error" class="error-message"></div>
                        </div>

                        <!-- Description -->
                        <div class="mb-4">
                            <label class="form-label">Full description</label>
                            <textarea placeholder="Type here" id="descriptionid" name="description" class="form-control border"
                                rows="4"></textarea>
                            <div id="description-error" class="error-message"></div>
                        </div>

                        <!-- Price and Quantity Row -->
                        <div class="row">
                            <div class="col-lg-4">
                                <div class="mb-4">
                                    <label class="form-label">Regular price</label>
                                    <input placeholder="$" name="regularPrice" type="text"
                                        class="form-control border">
                                    <div id="regularPrice-error" class="error-message"></div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="mb-4">
                                    <label class="form-label">Sale price</label>
                                    <input placeholder="$" name="salesPrice" type="text" class="form-control border">
                                    <div id="salePrice-error" class="error-message"></div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="mb-4">
                                    <label class="form-label">Quantity</label>
                                    <input placeholder="0" name="quantity" type="number" min="0" class="form-control border">
                                    <div id="quantity-error" class="error-message"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Color and Category Row -->
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="mb-4">
                                    <label class="form-label">Color</label>
                                    <input name="color" type="text" class="form-control border" placeholder="e.g. Red, Blue, etc.">
                                    <div id="color-error" class="error-message"></div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="mb-4">
                                    <label class="form-label">Category</label>
                                    <select class="form-select border" name="category">
                                        <%for(let i=0; i<cat.length; i++){%>
                                            <option value="<%=cat[i].name%>">
                                                <%=cat[i].name%>
                                            </option>
                                        <%}%>
                                    </select>
                                    <div id="category-error" class="error-message"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Images Section -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h4>Product Images</h4>
                                <small class="text-muted">Upload at least one product image.</small>
                            </div>
                            <div class="card-body">
                                <% for(let i=1; i<=4; i++){ %>
                                    <div class="image-upload-section">
                                        <label class="upload-label">Image <%= i %> <% if(i===1){ %>(Required)<% } else { %>(Optional)<% } %></label>
                                        <input class="form-control mb-2" type="file" name="images" id="input<%= i %>"
                                            accept=".png, .jpeg, .jpg"
                                            onchange="previewImage(event, <%=i%>)">
                                        <img src="" alt="Product Image" id="imgView<%= i %>" class="image-preview" style="display:none;">
                                    </div>
                                <% } %>
                                <div id="images-error" class="error-message"></div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="text-center">
                            <button class="btn btn-primary btn-lg" type="button" onclick="validateAndSubmit()" id="submitBtn">
                                <i class="fas fa-save"></i> Publish Product
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
function previewImage(event, index) {
    const input = event.target;
    const file = input.files[0];

    if (!file) return;

    // Validate file type
    if (!file.type.match(/^image\/(jpeg|jpg|png)$/)) {
        alert('Please select a valid image file (JPEG, JPG, or PNG)');
        input.value = '';
        return;
    }

    // Validate file size (5MB limit)
    if (file.size > 5 * 1024 * 1024) {
        alert('File size must be less than 5MB');
        input.value = '';
        return;
    }

    const reader = new FileReader();
    reader.onload = function() {
        const image = document.getElementById(`imgView${index}`);
        image.src = reader.result;
        image.style.display = "block";
    };
    reader.readAsDataURL(file);
}

let isSubmitting = false;

function validateAndSubmit() {
    if (isSubmitting) return;

    if (validateForm()) {
        isSubmitting = true;
        document.getElementById('submitBtn').disabled = true;
        document.getElementById('submitBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publishing...';
        setTimeout(() => {
            document.getElementById('productForm').submit();
        }, 500);
    }
}

function validateForm() {
    clearErrorMessages();

    const name = document.getElementsByName('productName')[0].value.trim();
    const description = document.getElementById('descriptionid').value.trim();
    const brand = document.getElementsByName('brand')[0].value;
    const regularPrice = document.getElementsByName('regularPrice')[0].value.trim();
    const salesPrice = document.getElementsByName('salesPrice')[0].value.trim();
    const color = document.getElementsByName('color')[0].value.trim();
    const category = document.getElementsByName('category')[0].value;
    const quantity = document.getElementsByName('quantity')[0].value.trim();

    let isValid = true;

    // Basic validations
    if (!name) {
        displayErrorMessage('productName-error', 'Product name is required.');
        isValid = false;
    }

    if (!description) {
        displayErrorMessage('description-error', 'Product description is required.');
        isValid = false;
    }

    if (!brand) {
        displayErrorMessage('brand-error', 'Please select a brand.');
        isValid = false;
    }

    if (!regularPrice) {
        displayErrorMessage('regularPrice-error', 'Regular price is required.');
        isValid = false;
    }

    if (!salesPrice) {
        displayErrorMessage('salePrice-error', 'Sale price is required.');
        isValid = false;
    }

    if (!quantity) {
        displayErrorMessage('quantity-error', 'Quantity is required.');
        isValid = false;
    }

    if (!color) {
        displayErrorMessage('color-error', 'Color is required.');
        isValid = false;
    }

    if (!category) {
        displayErrorMessage('category-error', 'Please select a category.');
        isValid = false;
    }

    // At least one image check
    let hasImages = false;
    for (let i = 1; i <= 4; i++) {
        const input = document.getElementById(`input${i}`);
        if (input.files.length > 0) {
            hasImages = true;
            break;
        }
    }

    if (!hasImages) {
        displayErrorMessage("images-error", 'Please upload at least one product image.');
        isValid = false;
    }

    return isValid;
}

function displayErrorMessage(elementId, message) {
    const errorElement = document.getElementById(elementId);
    if (errorElement) {
        errorElement.innerText = message;
        errorElement.style.display = "block";
    }
}

function clearErrorMessages() {
    const errorElements = document.getElementsByClassName('error-message');
    Array.from(errorElements).forEach(element => {
        element.innerText = '';
        element.style.display = 'none';
    });
}
</script>

<%- include("../../views/partial/admin/footer") %>
